<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<title>Lunch?</title>
		<!-- Kendo Styles -->
		<link rel="stylesheet" type="text/css" href="kendo/styles/kendo.common.min.css" />
		<link rel="stylesheet" type="text/css" href="kendo/styles/kendo.default.min.css" />
		<link rel="stylesheet" type="text/css" href="kendo/styles/kendo.mobile.common.min.css" />
		<link rel="stylesheet" type="text/css" href="kendo/styles/kendo.mobile.all.min.css" />
		
		<!-- Local Styles -->
		<link rel="stylesheet" type="text/css" href="styles/index.css" />
		
		<!--- Cordova - Loaded on mobile apps only -->
        <script type="text/javascript" src="cordova.js"></script>
		
		<!-- jQuery Js -->
		<script src="kendo/js/jquery-1.9.1.js"></script>
		
		<!-- Kendo Js -->
		<script src="kendo/js/kendo.all.js"></script>
	    <script src="kendo/js/everlive.all.js"></script>
		
		<!-- MillionMunkeys Js -->
		<script src="MillionMunkeys/KendoMunkey_1_0.js"></script>
		
		<!-- Catnip Code -->
        <script src="scripts/config.js"></script>
		
		<!-- Demo Code -->
        <script src="scripts/identity-provider.js"></script>
        <script src="scripts/main.js"></script>
		
		<!-- Initialize -->
		<script type="text/javascript">
			$(function() {
				app.initializeEverlive();
				
				// config.set("food", pi.observable());
				// config.set("food.categories", pi.data.DataSource.create({
				// 	source: "Everlive.FoodCategories"
				// })).fetch();
				// config.set("food.preferences", pi.data.DataSource.create({
				// 	source: "Everlive.DailyFoodPreferences",
				// 	change: function(e) {
				// 		var total = config.food.preferences.data().length;
				// 		for (var i=total; i<3; i++) {
				// 			config.food.preferences.add();
				// 		}
				// 		for (var i=total-1; i>2; i--) {
				// 			config.food.preferences.remove(config.food.preferences.at(i));
				// 		}
				// 	}
				// })).fetch();

				var dataUriPrefix = 'http://api.everlive.com/v1/kD5Tly50Vf6nm8kn/';

				var priorityToCategoryId = {};

				var userId = '1bac2d70-69a0-11e4-8481-bd60c9634975';

				(function() {
					var genresCount = 3;
					var genresBody = $('.genres tbody');
					var rowTemplate = genresBody.children().remove();

					var row;
					var i;
					for(i = 0; i < genresCount; i++) {
						row = rowTemplate.clone();
						row.find('.genre').attr('priority', i);
						genresBody.append(row);
					}
				})();

				(function() {
					$('.genre').each(function() {
						var combobox = $(this);
						var priority = combobox.attr('priority');
						combobox.kendoComboBox({
							dataTextField: "Name",
							dataValueField: "Id",
							dataSource: pi.data.DataSource.create({ // need one data source per combobox
								source: "Everlive.FoodCategories",
								
							}),
							filter: "contains",
							suggest: true,
							change: function() {
								priorityToCategoryId[priority] = this.value();
							}
						});
					});
					// TODO typing in entries to one of the boxes causes the others to show Id
				})();

				$('.set-genres').on('click', function() {
					var uri = dataUriPrefix + 'DailyFoodPreferences';

					var date = new Date();
					
					function getExisting() {
						var dateStr = date.getYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate();
						var filter = JSON.stringify({
							Date: dateStr
						});
						$.get(uri + '?filter=' + filter)
							// .done(deleteExisting); // TODO put back
							.done(postNew);
					}
					function deleteExisting(prefsRaw) {
						var prefs = prefsRaw.Result || [];
						if (prefs.length) {
							prefs.forEach(function(pref) {
								$.ajax({
									url: uri + '/' + pref.Id,
									type: 'DELETE',
									complete: postNew
								});
							});
						} else {
							postNew();
						}
					}
					function postNew() {
						var dateStr = date.toISOString();
						var newPrefs = Object.keys(priorityToCategoryId).sort().map(function(priority, normalizedPriority) {
							return {
								User: userId,
								Date: dateStr,
								PreferenceDate: dateStr,
								Priority: Number(normalizedPriority), // zero-based // TODO add Priority on persistence model
								FoodCategory: priorityToCategoryId[priority]
							};
						});
						if (newPrefs.length) {
							// $.post(uri, newPrefs);
							$.ajax({
								url: uri,
								type: 'POST',
								contentType: 'application/json',
								data: JSON.stringify(newPrefs)
							});
						}
					}
					getExisting();
				});
				
				new kendo.mobile.Application(document.body,{
					layout: "android-layout"
				});
			});
		</script>

	</head>
	
	<body>
        <div id="food" data-role="view" data-title="What?">
			<!-- <table data-role="grid" data-source="config.food.categories" data-toolbar="['add']">
				<thead>
					<tr>
						<th>Name</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td><input name="Name" type="text" value="" /></td>
					</tr>
				</tbody>
			</table> -->
			<!-- <table data-role="grid" data-source="config.food.preferences" data-toolbar="['add']">
				<thead>
					<tr>
						<th>Date</th>
						<th>Food</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td><input name="Date" type="number" value="" /></td>
						<td><select name="FoodCategory" data-source="config.food.categories"></select></td>
					</tr>
				</tbody>
			</table> -->

			<table class="genres" data-toolbar="['add']">
				<thead>
					<tr>
						<th>Name</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td><input class="genre" placeholder="Enter food genre"></td>
					</tr>
				</tbody>
			</table>
			<button class="set-genres">Set</button>
        </div>
		
		<div data-id="ios-layout" data-role="layout">
			<header data-role="header">
				<nav data-role="navbar">
					<a data-role="backbutton" data-align="left">Back</a>
					<div data-role="view-title">Lunch?</div>
				</nav>
			</header>
			<footer data-role="footer">
		        <div data-role="tabstrip">
					<a data-icon="home" href="login.html">Login</a>
					<a data-icon="recents" href="preferences.html">Daily Preferences</a>
					<a data-icon="cart" href="food.html">Food Preferences</a>
					<a data-icon="search" href="results.html">Results</a>
				</div>
	        </footer>
		</div>
		
		<div data-id="android-layout" data-role="layout">
			<header data-role="header">
				<nav data-role="navbar">
					<a data-role="button" data-rel="drawer" href="#drawer" data-align="left" style="transform:rotate(90deg)">|||</a>
					<div data-role="view-title">Lunch?</div>
				</nav>
			</header>
		</div>
		<div data-role="drawer" id="drawer">
			<ul data-role="listview" data-type="group">
				<li>Menu
					<ul>
						<li><a data-icon="home" href="login.html">Login</a></li>
						<li><a data-icon="recents" href="preferences.html">Daily Preferences</a></li>
						<li><a data-icon="cart" href="food.html">Food Preferences</a></li>
						<li><a data-icon="search" href="results.html">Results</a></li>
					</ul>
				</li>
			</ul>
		</div>
		
	</body>
</html>
